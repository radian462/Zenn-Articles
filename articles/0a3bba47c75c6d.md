---
title: "GitHub ActionsでGCE + GHCRのデプロイを自動化する"
emoji: "😊"
topics: []
published: false
---

DiscordのBotをGCEのデプロイを自動化するするにあたってつまずきまくったので、やり方を備忘録として書き残します。

# 使用するサービス
- Github Container Registry(GHCR)
- Google Compute Engine(GCE)
- Github Actions

# 始める前に
:::message
ここには、なぜこのような実装の仕方をしたのかを書いてあります。
「興味ねーよ。」って人は飛ばしてください。
:::

Google Cloud Platform(GCP)には、GHCRに相当するサービスにArtifact Registry、Github Actionsに相当するサービスにCloud Buildが提供されています。それらは同プラットフォームの機能のため、機能間の連携性が高く、実装コストも低く抑えられます。
しかし、あえてこれらのサービスを使わずに実装した理由はコストです。
Artifact Registryは0.5GBまで無料でそれ以上は課金という無料枠が設定されています。これは過去のイメージも含めて計算されるようで、わざわざ最新の以外のイメージを削除するように設定する必要があり、それに気づくまで課金されていたということがあり、その後も(多分自分のミスで)課金されていることがあったのでArtifact Registryを使うのに抵抗感が生じました。
一方で、GHCRはPublicなら無料という大きい無料枠があります。
もちろん、コストを気にしないなら、Cloud Build+Artifact Registryで実装する方が楽に実装できるのでそっちの方がいいと思います。

# GHCRにイメージをPushする
## Personal Access Token(PAT)を取得する
まずPersonal Access Token(PAT)を発行します。

# 参考
https://qiita.com/Jazuma/items/aca397e081a7825d0dec
https://zenn.dev/kou_pg_0131/articles/gh-actions-oidc-gcp
